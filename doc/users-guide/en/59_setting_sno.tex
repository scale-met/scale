%-------------------------------------------------------------------------------
\section{SCALE NetCDF Operator (\sno)} \label{sec:snoutil}
%-------------------------------------------------------------------------------

In default, the output file of \scalerm (called as \scalenetcdf file) is divided according to the horizontal domain decomposition by the multiple processes. This style is efficient to the throughput of the file I/O during the model simulation. However, it is hard to handle a lot of files. The number of the file increases with increasing the number of process, and we cannot use these files for the next simulation, with changing only the number of the MPI processes. Furthermore, many analytical and visualization tools do not support such distributed files. One solution to these problems is the aggregation of the output file. We can use the Parallel \netcdf (PnetCDF). Please refer to Section \ref{subsec:single_io}. The other solution is usage of the post process tool \sno. \sno has the feature as follows:

\begin{itemize}
 \item Combine the divided multiple files into a single file or multiple files
 \item Divide a single file or multiple files into multiple files
 \item Generate *.ctl file for reading the single \Netcdf file by \grads
 \item Convert to \grads format file
 \item Average multiple steps in the output data
 \item Regrid to geodesic (latitude-longitude) grid system
\end{itemize}

By using \sno, you can manipulate the history, topography, boundary, and initial/restart data whether the files have the halo grids or not.

\subsubsection{Limitations}

\sno is available for the \scalenetcdf file generated by the \scalelib version 5.3 or newer. Because of the less information in the global attributes and the attributes of the axis data, older \scalenetcdf files are not available.
\sno is executable with multiple processes. However, a maximum number of the available process is limited by the number of output files from \sno. For example, if you want to convert the hundreds of \scalenetcdf file to a single file, you can use only one MPI process for that operation.
For GrADS format, it is difficult to contain the plural variables with the different vertical layer. Thus each variable is output to the individual aggregated file.

Rearrangement of the multiple file is still limited. Each file must have the same size of the horizontal grid (without considering halo grid). An example is described in the configuration sample below.

\subsubsection{Usage}

The executable binary of \sno is not compiled together with the main program of \scalerm. \sno uses the \scalelib library \verb|libscale.a|, which will be located under the \texttt{scale-{\version}/lib} directory. This library is generated at the time of compilation of \scalerm. So we recommend to execute the following command after the compilation of \scalerm:

\begin{alltt}
  $  cd scale-{\version}/scale-rm/util/sno
  $  make
\end{alltt}

If the compilation succeeds, the executable binary file is generated under the \texttt{scale-{\version}/bin} directory.
The execution sample of \sno is  as follows:

\begin{alltt}
  $  mpirun -n 2 ./sno sno.conf
\end{alltt}

In this sample, \sno is executed with two MPI processes by using ``mpirun'' command. The last argument is the configuration file. Any name is available for this file.

\subsection{Samples of configuration: basic usage}

\subsubsection{Common configurations}

\sno shares some components with \scalerm. You can configure following namelist
parameters:

\begin{itemize}
 \item \namelist{PARAM_IO}: Log file \ref{sec:log}
 \item \namelist{PARAM_PROF}: Performance Profiler \ref{subsec:prof}
 \item \namelist{PARAM_CONST}: Physical Constants, \ref{subsec:const}
 \item \namelist{PARAM_CALENDAR}: Calendar, \ref{subsec:calendar}
\end{itemize}

If no options are specified for \namelist{PARAM_IO}, the progress log is output to standard output from a master process.

\subsubsection{Multiple \scalenetcdf files to a single NetCDF file}

\editbox{
\verb|&PARAM_SNO                              | \\
\verb| basename_in     = 'input/history_d02', | \\
\verb| dirpath_out     = 'output',            | \\
\verb| basename_out    = 'history_d02_new',   | \\
\verb| output_gradsctl = .true.,              | \\
\verb|/                                       | \\
}

This example converts history file named \verb|history_d02.pe######.nc| in the directory \verb|./input|, where \verb|######| represents the MPI process number.
The information of the divided files, such as the total number of files and the 2-D topology, is read from the first file (in this case, \verb|history_d02.pe000000.nc|). The converted file is output to \verb|./output| directory with the new name \verb|history_d02_new.pe######.nc|.
Options about the number of output file and variables are not not specified in this example. In this case, input files are combined to a single file and all variables are kept.

When \nmitem{output_gradsctl} is \verb|.true.|, \sno outputs a control file for \grads. This file is generated only when the output file is single. A sample of detail of the control file is as follows:

\msgbox{
\verb|SET ^history_d02.pe000000.nc| \\
\verb|TITLE SCALE-RM data output| \\
\verb|DTYPE netcdf| \\
\verb|UNDEF -0.99999E+31| \\
\verb|XDEF    88 LINEAR    134.12     0.027| \\
\verb|YDEF    80 LINEAR     33.76     0.027| \\
\verb|ZDEF    35 LEVELS| \\
\verb|   80.841   248.821   429.882   625.045   835.409  1062.158  1306.565  1570.008  1853.969| \\
\verb| 2160.047  2489.963  2845.574  3228.882  3642.044  4087.384  4567.409  5084.820  5642.530| \\
\verb| 6243.676  6891.642  7590.075  8342.904  9154.367 10029.028 10971.815 11988.030 13083.390| \\
\verb|14264.060 15536.685 16908.430 18387.010 19980.750 21698.615 23550.275 25546.155| \\
\verb|TDEF    25  LINEAR  00:00Z01MAY2010   1HR| \\
\verb|PDEF    80    80 LCC     34.65    135.22    40    40     30.00     40.00    135.22   2500.00   2500.00| \\
\verb|VARS    3| \\
\verb|U=>U   35 t,z,y,x velocity u| \\
\verb|PREC=>PREC    0 t,y,x surface precipitation flux| \\
\verb|OCEAN_SFC_TEMP=>OCEAN_SFC_TEMP    0 t,y,x ocean surface skin temperature| \\
\verb|ENDVARS| \\
}

Generally, a single \netcdf file is readable by \grads without any extrnal metadata file. However, \grads interface is limited and cannot understand the \scalenetcdf format, which contains the assosiated coodinates and the map projections. That is because we need the control file.

\subsubsection{Multiple \scalenetcdf files to GrADS file}

\editbox{
\verb|&PARAM_SNO                                | \\
\verb| basename_in  = 'input/history_d02',      | \\
\verb| dirpath_out  = 'output',                 | \\
\verb| output_grads = .true.,                   | \\
\verb| vars         = "U", "PREC", "LAND_TEMP", | \\
\verb|/                                         | \\
}

If \nmitem{output_grads} is \verb|.true.|, \sno outputs \grads format file instead of the \scalenetcdf format. All of the decomposed data is combined spatially. Each variable is output individual file. Each file name is set to be the same as a variable name. The converted file is output to \verb|./output| directory. Note that the output path will not be set if you specify \nmitem{basename_out}. The control files are also generated.
In this example, the conversion is applied only for the variables specified by \nmitem{vars}.

\subsubsection{Multiple \scalenetcdf files to multiple NetCDF file}

\editbox{
\verb|&PARAM_SNO                            | \\
\verb| basename_in  = 'input/history_d02',  | \\
\verb| basename_out = 'output/history_d02', | \\
\verb| nprocs_x_out = 4,                    | \\
\verb| nprocs_y_out = 6,                    | \\
\verb|/                                     | \\
}

In this example, the number of input file is 4 ([x,y]=[2,2]) and each file has 30 grids (without halo) for x- and y-direction. The number of output file is 24 ([x,y]=[4,6]). As mentioned above, every file must have same size of grid after the redistribution. In this case, output file have 15 and 10 grids for x- and y- direction, respectively. You cannot set \verb|nprocs_y_out| to 7 because 30x2=60 is indivisible by 7.

You can get the informations for redistribution by checking the global attribute in \scalenetcdf file. For example, you can display the header informations by using ``ncdump'' command as follows:

\begin{alltt}
  $  ncdump -h history_d02.pe000000.nc
\end{alltt}

You will find the global attributes at the end of dumped information.

\msgbox{
\verb|  ......                                           | \\
\verb|// global attributes:                              | \\
\verb|  ......                                           | \\
\verb|     :scale_cartesC_prc_rank_x = 0 ;               | \\
\verb|     :scale_cartesC_prc_rank_y = 0 ;               | \\
\verb|     :scale_cartesC_prc_num_x = 2 ;                | \\
\verb|     :scale_cartesC_prc_num_y = 2 ;                | \\
\verb|  ......                                           | \\
\verb|     :scale_atmos_grid_cartesC_index_imaxg = 60 ;  | \\
\verb|     :scale_atmos_grid_cartesC_index_jmaxg = 60 ;  | \\
\verb|  ......                                           | \\
}

\verb|scale_cartesC_prc_num_x| and \verb|scale_cartesC_prc_num_y| are the sizes of x- and y-direction in the 2-D file topology, respectively. \verb|scale_cartesC_prc_rank_x| and \verb|scale_cartesC_prc_rank_y| are the x- and y-positions of this file in the 2-D map, respectively. The rank number starts from 0.
\verb|scale_atmos_grid_cartesC_index_imaxg| and \verb|scale_atmos_grid_cartesC_index_jmaxg| are the sizes of x- and y-grids in  domain total, respectively. These numbers do not contain halo grid. Thus, you can use the divisor of these sizes for the division number of x- and y-directions.

\subsubsection{Summary}

Here we describe the detail of options in \namelist{PARAM_SNO}.

\editboxtwo{
\verb|&PARAM_SNO                  | & \\
\verb| basename_in     = "",      | & ; path and basename of the input file(s) \\
\verb| dirpath_out     = "",      | & ; output path \\
\verb| basename_out    = "",      | & ; basename of the output file \\
\verb| nprocs_x_out    = 1,       | & ; division number of file in x-direction \\
\verb| nprocs_y_out    = 1,       | & ; division number of file in y-direction \\
\verb| vars            = "",      | & ; name of variables to operate \\
\verb| output_grads    = .false., | & ; output with grads format? \\
\verb| output_gradsctl = .false., | & ; output grads control file for the single \netcdf file? \\
\verb| debug           = .false., | & ; output verbose log for debugging? \\
\verb|/                           | & \\
}

\nmitem{basename_in} is always required. If \nmitem{dirpath_out} is empty, the path for output is set to the current directory.
\nmitem{basename_out} is used for \scalenetcdf file. If \nmitem{output_grads} is set to \verb|.true.|, output name is same as the name of each variable and \nmitem{basename_out} is ignored.

The default value of \nmitem{nprocs_x_out} and \nmitem{nprocs_y_out} is 1. It means that multiple files are combined to a single file.
Note that the number of MPI processes for SNO must be same as, or less than the total number of output files (= \nmitem{nprocs_x_out} x \nmitem{nprocs_y_out}).

If \nmitem{vars} is not specified, all of variables in the input file are processed.

\subsection{Samples of configuration: plugin functions}

Some features of \sno is provided as the plugin. You can apply the operators, such as time averaging and horizontal remapping, before outputting the combined/divided files.

\subsubsection{Monthly averaging}

\editbox{
\verb|&PARAM_SNO                             | \\
\verb| basename_in  = 'input/history_d02',   | \\
\verb| basename_out = 'output/history_d02',  | \\
\verb| nprocs_x_out = 2,                     | \\
\verb| nprocs_y_out = 2,                     | \\
\verb|/                                      | \\
\verb|                                       | \\
\verb|&PARAM_SNOPLGIN_TIMEAVE                | \\
\verb| SNOPLGIN_timeave_type     = 'NUMBER', | \\
\verb| SNOPLGIN_timeave_interval = 4,        | \\
\verb|/                                      | \\
}

In this sample, the number of input file is 4, too. So the number of the files does not change by this conversion.
When \nmitem{SNOPLGIN_timeave_type} in \namelist{PARAM_SNOPLGIN_TIMEAVE} is set to \verb|'NUMBER'|, the data is averaged in time axis. The averaging interval is specified by \nmitem{SNOPLGIN_timeave_interval}. In this case, the variables is averaged by every 4 output-steps.

The other sample is as follows:

\editbox{
\verb|&PARAM_SNO                            | \\
\verb| basename_in  = 'input/history_d02',  | \\
\verb| basename_out = 'output/history_d02', | \\
\verb|/                                     | \\
\verb|                                      | \\
\verb|&PARAM_SNOPLGIN_TIMEAVE               | \\
\verb| SNOPLGIN_timeave_type = 'MONTHLY',   | \\
\verb|/                                     | \\
}

Both the file aggregation and the time averaging are applied in this sample.\\
When \nmitem{SNOPLGIN_timeave_type} is set to \verb|'DAILY'|, \verb|'MONTHLY'|, or \verb|'ANNUAL'|, \sno try to daily, monthly, annual average of the variables. The date and time of the data are read from the file.
If you used ideal calendar for the simulation, you have to add same setting of \namelist{PARAM_CALENDAR} for the config file of \sno.

\subsubsection{Regrid to 0.5 degree}

\editbox{
\verb|&PARAM_SNO                               | \\
\verb| basename_in  = 'input/history_d02',     | \\
\verb| basename_out = 'output/history_d02',    | \\
\verb|/                                        | \\
\verb|                                         | \\
\verb|&PARAM_SNOPLGIN_HGRIDOPE                 | \\
\verb| SNOPLGIN_hgridope_type      = 'LATLON', | \\
\verb| SNOPLGIN_hgridope_lat_start = 30.0,     | \\
\verb| SNOPLGIN_hgridope_lat_end   = 40.0,     | \\
\verb| SNOPLGIN_hgridope_dlat      = 0.5,      | \\
\verb| SNOPLGIN_hgridope_lon_start = 130.0,    | \\
\verb| SNOPLGIN_hgridope_lon_end   = 140.0,    | \\
\verb| SNOPLGIN_hgridope_dlon      = 0.5,      | \\
\verb|/                                        | \\
}

When \nmitem{SNOPLGIN_hgridope_type} in \namelist{PARAM_SNOPLGIN_HGRIDOPE} is set to \verb|'LATLON'|, horizontal remapping to the latitude-longitude grid system is applied. This plugin operator is available only when the output file is single.
The other options in \namelist{PARAM_SNOPLGIN_HGRIDOPE} set the boundary of the output domain and the number of grid points. The size of longitude grid point \verb|nlon| is calculated as follows:

\begin{eqnarray}
  \nmitemeq{nlon} = \frac{\nmitemeq{SNOPLGIN_hgridope_lon_end} - \nmitemeq{SNOPLGIN_hgridope_lon_start} }{\nmitemeq{SNOPLGIN_hgridope_dlon}} \nonumber.
\end{eqnarray}
\noindent
The result of this calculation is rounded to an integer. Thus, the longitude of the easternmost grid point may become smaller than \nmitem{SNOPLGIN_hgridope_lon_end}.
The size of latitude grid point is calculated in the same manner as that of longitude.

You can set the lat-lon domain larger than the original domain size used in the simulation. In remapping process, extrapolation is not allowed. An missing value is filled to the grid, which has no interpolated value.
