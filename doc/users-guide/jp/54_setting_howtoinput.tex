\section{\SecInputDataSetting} \label{sec:adv_datainput}
%====================================================================================

\begin{table}[htb]
\begin{center}
\caption{\scalelib で対応している外部入力データ}
\begin{tabularx}{150mm}{|l|l|X|} \hline
 \rowcolor[gray]{0.9} データ形式      & \verb|FILETYPE_ORG|  & 備考 \\ \hline
 SCALEデータ形式   & \verb|SCALE-RM|     &  ヒストリファイルのみ対応。latlonカタログを必要とする。 \\ \hline
 バイナリ形式 & \verb|GrADS|        & データ読み込み用のネームリストを別途必要とする。       \\ \hline
% NICAMデータ   & \verb|NICAM-NETCDF| & NetCDF形式の緯度経度格子に変換されたデータに対応する。 \\ \hline
 WRFデータ形式     & \verb|WRF-ARW|      & 「wrfout」、「wrfrst」の両方に対応する。          \\ \hline
\end{tabularx}
\label{tab:inputdata_format}
\end{center}
\end{table}

\scalerm では、表\ref{tab:inputdata_format}に示される様々な種類の外部データを読み込むことによって、初期値データや境界値データを作成できる。
プログラム\verb|scale-rm_init|は、ファイル\verb|init.conf|の設定に従って外部データを初期値・境界値データに変換する。
入力データの形式は、\namelist{PARAM_MKINIT_REAL_***}の\nmitem{FILETYPE_ORG}で指定する。

SCALEデータ形式は主にオフライン・ネスティング実験で使用される。
詳細については、第\ref{subsec:nest_offline}節を参照されたい。

WRFデータ形式も使用でき、WRFによるモデル出力データを直接使用できる。
ただし、ファイルは{\scalerm}の境界値データの作成に必要な全てのデータを含まなければならない。

本書における「バイナリデータ形式」は、Fortran が直接アクセスできる単精度浮動小数点のバイナリデータとして定義される。
例えば GRIB/GRIB2 データなどの他のフォーマットデータは、バイナリデータ形式に変換することで {\scalerm} に読み込ませることができる。
この方法は、第\ref{sec:tutrial_real_data}節で説明する。


{\scalelib}の最新版の出力ファイル形式は、バージョン5.3以前の形式とは異なる。
そのため、バージョン5.3以前で作成された初期値/境界値ファイルは本バージョン（{\scalelib}{\version})では使用できない。

%%%---------------------------------------------------------------------------------%%%%
\subsubsection{バイナリ形式データの入力} \label{sec:datainput_grads}

バイナリデータ({\grads}形式)を入力ファイルに用いる場合、ユーザはデータを予め用意しておく必要がある。
バイナリデータ({\grads}形式)の形式については、\grads の Web ページ
(\url{http://cola.gmu.edu/grads/gadoc/aboutgriddeddata.html#structure})を参照されたい。
入力データに関する設定は、設定ファイル\verb|init.conf|の\namelist{PARAM_MKINIT_REAL_***}で以下のように指定する。\\

\editbox{
\verb|&PARAM_RESTART|\\
\verb| RESTART_OUTPUT       = .true.,|\\
\verb| RESTART_OUT_BASENAME = "init_d01",|\\
\verb|/|\\
\\
\verb|&PARAM_MKINIT_REAL_ATMOS|\\
\verb| NUMBER_OF_FILES            = 2,|\\
\verb| NUMBER_OF_TSTEPS           = 1, |\\
\verb| FILETYPE_ORG               = "GrADS",|\\
\verb| BASENAME_ORG               = "namelist.grads_boundary.FNL.2005053112-2016051106",|\\
\verb| BASENAME_BOUNDARY          = "boundary_d01",|\\
\verb| BOUNDARY_UPDATE_DT         = 21600.0,|\\
\verb| USE_FILE_DENSITY           = .false.,|\\
\verb| USE_NONHYDRO_DENS_BOUNDARY = .false.,|\\
\verb| USE_SFC_DIAGNOSES          = .false.,|\\
\verb| USE_DATA_UNDER_SFC         = .true.,|\\
\verb| SAME_MP_TYPE               = .false.,|\\
\verb|/|\\
\verb|&PARAM_MKINIT_REAL_OCEAN|\\
\verb| NUMBER_OF_FILES      = 2,|\\
\verb| NUMBER_OF_TSTEPS     = 1, |\\
\verb| FILETYPE_ORG         = "GrADS",|\\
\verb| BASENAME_ORG         = "namelist.grads_boundary.FNL.2005053112-2016051106",|\\
\verb| INTRP_OCEAN_SFC_TEMP = "mask",|\\
\verb| INTRP_OCEAN_TEMP     = "mask",|\\
\verb|/|\\
\verb|&PARAM_MKINIT_REAL_LAND|\\
\verb| NUMBER_OF_FILES      = 2,|\\
\verb| NUMBER_OF_TSTEPS     = 1, |\\
\verb| FILETYPE_ORG         = "GrADS",|\\
\verb| BASENAME_ORG         = "namelist.grads_boundary.FNL.2005053112-2016051106",|\\
\verb| USE_FILE_LANDWATER   = .true.,|\\
\verb| INTRP_LAND_TEMP      = "fill",|\\
\verb| INTRP_LAND_WATER     = "fill",|\\
\verb| INTRP_LAND_SFC_TEMP  = "fill",|\\
\verb|/|\\
}


バイナリデータを読み込むときは、\nmitem{FILETYPE_ORG}に\verb|"GrADS"|を設定する。
\scalerm では バイナリデータ({\grads}形式)のファイル名やデータ構造について、
「ctl」ファイルの代わりに、ネームリストファイル\verb|namelist.grads_boundary**|で指定する。
このネームリストファイルも予め用意しておく必要がある。
ネームリストファイルは、\nmitem{BASENAME_ORG}で指定する。


\nmitem{NUMBER_OF_FILES}は入力ファイルの数である。
入力ファイルのベース名は、ネームリストファイル内の\verb|fname|で設定する。
\verb|fname="filename"| と指定されている場合、
入力ファイルが１つのときは、入力ファイルは「\verb|filename.grd|」という名前で準備する。
入力ファイルが複数あるとき、もしくは、\nmitem{BASENAME_ADD_NUM} = \verb|.true.|の場合には、
「\verb|filename.XXXXX.grd|」と番号付けされたファイルを準備する。
プログラム\verb|scale-rm_init|は、\verb|00000|から\nmitem{NUMBER_OF_FILES}-1 までの数字を付けたファイルを順に読み込む。

\nmitem{NUMBER_OF_TSTEPS}は各ファイル中に保存されているデータの時間ステップ数である。

\nmitem{BOUNDARY_UPDATE_DT}は入力データの時間間隔である。
変換された初期値ファイルのヘッダー名は、\namelist{PARAM_RESTART}の\nmitem{RESTART_OUT_BASENAME}で設定する。
\nmitem{BASENAME_BOUNDARY}は、変換された境界値ファイルのヘッダー名である。
\nmitem{BASENAME_BOUNDARY}を指定しなければ、 境界値ファイルは出力されない。
つまり、上記の例では、境界値ファイルは大気データのみ作成される。初期値ファイルは、大気、海洋、陸面すべてについて作成される。


\nmitem{INTRP_TYPE}で空間補間の種類を指定する。
\verb|``LINEAR''|と \verb|``DIST-WEIGHT''|が設定可能である。
\verb|``LINEAR''|の場合は2次元線形補間が用いられ、\verb|``DIST-WEIGHT''|の場合は隣接$N$点の距離重み付け平均が用いられる。
距離重み付け平均の場合、隣接点の数は\namelist{PARAM_COMM_CARTESC_NEST}の\nmitem{COMM_CARTES_NEST_INTERP_LEVEL}で設定される。

以上の設定は、\namelist{PARAM_MKINIT_REAL_ATMOS}、
\namelist{PARAM_MKINIT_REAL_OCEAN}、\\
\namelist{PARAM_MKINIT_REAL_LAND}の間で共通である。
\namelist{PARAM_MKINIT_REAL_OCEAN}や \\
\namelist{PARAM_MKINIT_REAL_LAND}に関しては、別途指定しない限り、
\namelist{PARAM_MKINIT_REAL_ATMOS}で設定された値が基本的に引き継がれる。
%

\nmitem{USE_FILE_DENSITY}と\nmitem{USE_NONHYDRO_DENS_BOUNDARY}は
密度の計算方法に関する設定を行う。
デフォルトの設定は、
\nmitem{USE_FILE_DENSITY} = \verb|.false.| 及び 
\nmitem{USE_NONHYDRO_DENS_BOUNDARY} = \verb|.false.|であり、
この時、初期値・境界値の密度は、読み込んだ温度と比湿データから静水圧平衡 ($\frac{dp}{dz}=-\rho g$) を仮定して計算される。
%（ここで見積った密度は、親モデルの密度とは必ずしも一致しない）。
\nmitem{USE_FILE_DENSITY} = \verb|.true.|の場合、他の変数同様に、
入力ファイルから読み込んだ密度の値を初期値・境界値として使用する。
\nmitem{USE_NONHYDRO_DENS_BOUNDARY} = \verb|.true.|の場合は、\nmitem{USE_FILE_DENSITY}の設定にかかわらず、境界値データの密度のみ、気温、気圧、比湿などの入力データをもとに状態方程式 ($\rho = p/RT$) によって計算される。
（ここで計算された密度は、一般的には親モデルの値と整合的である）。
\nmitem{USE_NONHYDRO_DENS_BOUNDARY} の設定は初期値データには影響しない。
%\nmitem{USE_FILE_DENSITY}=\verb|.false.|かつ\\ \nmitem{USE_FILE_DENSITY}=\verb|.true.|の場合は、初期値データおよび境界値データの密度は異なるものとなる。
このオプションが用意された理由は次の通りである。
多くの場合、計算初期ショックを抑えるため、初期値データは静水圧平衡にある密度を使うのが望ましい。
一方、静水圧平衡により作成した密度は
親モデルの密度（多くの場合、実際の値に近いと期待される）と一致しない場合があり、
これが、\scalerm での計算結果に大きな質量バイアスを生じる可能性がある。
そのような場合、気圧の再現性などの観点において、
\nmitem{USE_NONHUDRO_DENS_BOUNDARY}=\verb|.true.|として親モデルとの整合的な密度を与える方が良い場合がある。
境界値に静水圧平衡からずれた密度を使うことにより生じる鉛直加速や波は、境界領域ナッジングにより速やかに減衰されると期待される。


\nmitem{USE_SFC_DIAGNOSES}は親モデルの最下層高度よりも低い層における値の計算のためのスイッチである。
\nmitem{USE_SFC_DIAGNOSES} = \verb|.true.|の場合, T2, RH2, U10, V10, PSFC といった地表面変数が使われるが、そうでない場合には、等温位および静水圧平衡の仮定のもとで計算される。

\nmitem{USE_DATA_UNDER_SFC}は入力データ中の地表よりも低い層のデータを使うか無視するかを決めるのスイッチである。
地表よりも低いデータは、高い山岳域において、高い気圧面で現れることがある。


\nmitem{SAME_MP_TYPE}は親モデルと同じ雲微物理スキームを使うかどうかを指定するパラメータである。
これは\nmitem{FILETYPE_ORG} = \verb|''SCALE-RM''|でのみ有効である。



土壌水分の設定は、\verb|init.conf|の\namelist{PARAM_MKINIT_REAL_LAND}の
\nmitem{USE_FILE_LANDWATER}で行う。
土壌水分データの与え方は、(1)親モデルの値など入力データとして与える方法(\nmitem{USE_FILE_LANDWATER} = \verb|.true.|)と、
(2)領域全体で一定値を与える方法(\nmitem{USE_FILE_LANDWATER} = \verb|.false.|)の２種類ある。
(1)の場合には、3次元の土壌水分データとして
\verb|SMOISVC|か\verb|SMOISDS|のどちらかを用意する必要がある。
体積含水率(\verb|SMOISVC|)は土の体積$V$の中に占める水の体積$V_w$の割合($V_w / V$)である。
また、飽和度(\verb|SMOISDS|)は$V$の中に占める間隙の体積$V_v$に対する水の体積$V_w$の割合($V_w / V_v$)である。
%
(2)の場合には、以下の例のように、土壌空隙率に対する水が占める割合(飽和度)を
\verb|INIT_LANDWATER_RATIO| で指定する。デフォルト値は 0.5 である。
また、単位体積あたりの土壌の隙間の大きさ(空隙率)は土地利用に応じて変わる。
\editboxtwo{
\verb|&PARAM_MKINIT_REAL_LAND| &\\
\verb| USE_FILE_LANDWATER   = .false.| & 土壌水分をファイルから読むかどうか。デフォルトは\verb|.true.| \\
\verb| INIT_LANDWATER_RATIO = 0.5    | & \verb|USE_FILE_LANDWATER=.false.|の場合、 \\
                                       & 飽和度。\\
\verb|  .....略.....                 | & \\
\verb|/| & \\
}



バイナリデータのファイル名やデータ構造を指定する
ネームリストファイル(\verb|namelist.grads_boundary**|)の一例を下記に示す。
\editbox{
\verb|#| \\
\verb|# Dimension    |  \\
\verb|#|                \\
\verb|&GrADS_DIMS|  \\
\verb| nx     = 360,|~~~   ; default value of the number of grids in the x direction \\
\verb| ny     = 181,|~~~   ; default value of the number of grids in the y direction \\
\verb| nz     = 26, |~~~~~ ; default value of the number of layers in the z direction \\
\verb|/|                \\
\\
\verb|#              |  \\
\verb|# Variables    |  \\
\verb|#              |  \\
\verb|&GrADS_ITEM  name='lon',     dtype='linear',  swpoint=0.0d0,   dd=1.0d0 /  |  \\
\verb|&GrADS_ITEM  name='lat',     dtype='linear',  swpoint=90.0d0,  dd=-1.0d0 / |  \\
\verb|&GrADS_ITEM  name='plev',    dtype='levels',  lnum=26,| \\
~~~\verb|      lvars=100000,97500,.........,2000,1000, /     |  \\
\verb|&GrADS_ITEM  name='HGT',     dtype='map',     fname='FNLatm', startrec=1,  totalrec=125 / |  \\
\verb|&GrADS_ITEM  name='U',       dtype='map',     fname='FNLatm', startrec=27, totalrec=125 / |  \\
\verb|&GrADS_ITEM  name='V',       dtype='map',     fname='FNLatm', startrec=53, totalrec=125 / |  \\
\verb|&GrADS_ITEM  name='T',       dtype='map',     fname='FNLatm', startrec=79, totalrec=125 / |  \\
\verb|&GrADS_ITEM  name='RH',      dtype='map',     fname='FNLatm', startrec=105,totalrec=125, nz=21 /  |  \\
\verb|&GrADS_ITEM  name='MSLP',    dtype='map',     fname='FNLsfc', startrec=1,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='PSFC',    dtype='map',     fname='FNLsfc', startrec=2,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='SKINT',   dtype='map',     fname='FNLsfc', startrec=3,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='topo',    dtype='map',     fname='FNLsfc', startrec=4,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='lsmask',  dtype='map',     fname='FNLsfc', startrec=5,  totalrec=9  /  |  \\
\verb|&GrADS_ITEM  name='U10',     dtype='map',     fname='FNLsfc', startrec=6,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='V10',     dtype='map',     fname='FNLsfc', startrec=7,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='T2',      dtype='map',     fname='FNLsfc', startrec=8,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='RH2',     dtype='map',     fname='FNLsfc', startrec=9,  totalrec=9   / |  \\
\verb|&GrADS_ITEM  name='llev',    dtype='levels',  nz=4, lvars=0.05,0.25,0.70,1.50, /        |  \\
~~~~~~~~\verb| missval=9.999e+20 /|  \\
\verb|&GrADS_ITEM  name='STEMP',   dtype='map',     fname='FNLland', nz=4, startrec=1, totalrec=8,|\\
~~~~~~~~\verb| missval=9.999e+20 /|  \\
\verb|&GrADS_ITEM  name='SMOISVC', dtype='map',     fname='FNLland', nz=4, startrec=5, totalrec=8,|\\
~~~~~~~~\verb| missval=9.999e+20 /|  \\
}


格子数のデフォルト値は\namelist{GrADS_DIMS}の\verb|nx, ny, nz|で指定する。
また、入力データに関する設定は、各変数ごとに\namelist{GrADS_ITEM}を用意し指定する。
\namelist{GrADS_ITEM}に関する説明は、表\ref{tab:namelist_grdvar}に示す。

ある変数の格子数がデフォルト値と異なる場合には、\namelist{GrADS_ITEM}でその変数の格子数を設定することができる。
例えば、ある層から上では、QVやRHのデータが利用できない場合がある。
その場合には、データが存在する層数を\verb|nz|で指定する。
\verb|nz|より上層での値の与え方として２種類の方法を用意している。
デフォルトは、QV=0（\verb| upper_qv_type = "ZERO"|）である。
\editboxtwo{
\verb|&PARAM_MKINIT_REAL_GrADS| & \\
\verb| upper_qv_type = "ZERO"| & \verb|"ZERO"|: QV=0 \\
                               & \verb|"COPY"|: 湿度の入力データが存在する最上層のRHを、データが存在しない上層にコピーする\\
\verb|/|\\
}

\scalerm の計算に必要な変数のリストは、表\ref{tab:grdvar_item}に示す。

{\small
\begin{table}[htb]
\begin{center}
\caption{\namelist{GrADS_ITEM}の変数}
\label{tab:namelist_grdvar}
\begin{tabularx}{150mm}{llX} \hline
\rowcolor[gray]{0.9} \verb|GrADS_ITEM|の項目  & 説明 & 備考 \\ \hline
\multicolumn{1}{l}{name}    & \multicolumn{1}{l}{変数名} & 表\ref{tab:grdvar_item}より選択      \\
\multicolumn{1}{l}{dtype}   & \multicolumn{1}{l}{データ形式} & \verb|"linear"|, \verb|"levels"|, \verb|"map"|から選択 \\\hline
\multicolumn{3}{l}{\nmitem{dtype}が\verb|"linear"|の場合のネームリスト (\verb|"lon", "lat"|専用)} \\ \hline
\multicolumn{1}{l}{fname}    & \multicolumn{1}{l}{ファイル名の頭}       &  \\
\multicolumn{1}{l}{swpoint}  & \multicolumn{1}{l}{スタートポイントの値} &  \\
\multicolumn{1}{l}{dd}       & \multicolumn{1}{l}{増分}                 &  \\ \hline
\multicolumn{3}{l}{\nmitem{dtype}が\verb|"levels"|の場合のネームリスト (\verb|"plev", "llev"|専用)} \\ \hline
\multicolumn{1}{l}{lnum}     & \multicolumn{1}{l}{レベルの数(層数)}     &  \\
\multicolumn{1}{l}{lvars}    & \multicolumn{1}{l}{各層の値}             &  \\ \hline
\multicolumn{3}{l}{\nmitem{dtype}が\verb|"map"|の場合のネームリスト}           \\ \hline
\multicolumn{1}{l}{startrec} & \multicolumn{1}{l}{変数\nmitem{item}のレコード番号} &  \multicolumn{1}{l}{t=1 の時刻の値}\\
\multicolumn{1}{l}{totalrec} & \multicolumn{1}{l}{一時刻あたりの全変数のレコード長}  &  \\
\multicolumn{1}{l}{missval}  & \multicolumn{1}{l}{欠陥値の値}   　    & \multicolumn{1}{l}{(オプション)}\\ \hline
\multicolumn{1}{l}{nx}       & \multicolumn{1}{l}{x方向の格子数} & \multicolumn{1}{l}{(オプション)}\\ \hline
\multicolumn{1}{l}{ny}       & \multicolumn{1}{l}{y方向の格子数} & \multicolumn{1}{l}{(オプション)}\\ \hline
\multicolumn{1}{l}{nz}       & \multicolumn{1}{l}{z方向の層数} & \multicolumn{1}{l}{(オプション)}\\ \hline
\multicolumn{1}{l}{yrev}     & データが北から南の順に記録されている場合は\verb|.true.|とする & \multicolumn{1}{l}{(オプション)} \\ \hline
\end{tabularx}
\end{center}
\end{table}
}


{\small
\begin{table}[hbt]
\begin{center}
\caption{\namelist{GrADS_ITEM}の\nmitem{name}の変数リスト。
アスタリスクは「オプションであるが、可能な限り推奨される」ことを意味する。
二重のアスタリスクは、「利用できるが、推奨されない」ことを意味する。
}
\label{tab:grdvar_item}
\begin{tabularx}{150mm}{rl|l|l|l} \hline
 \rowcolor[gray]{0.9} & 変数名 & 説明 & 単位 & \nmitem{dtype} \\ \hline
           &\verb|lon|     & 経度データ                 & [deg.]   & \verb|linear, map| \\
           &\verb|lat|     & 緯度データ                 & [deg.]   & \verb|linear, map| \\
           &\verb|plev|    & 気圧データ                 & [Pa]     & \verb|levels, map| \\
    $\ast$ &\verb|HGT|     & 高度(ジオポテンシャル)データ & [m]      & \verb|map| \\
    $\ast$ &\verb|DENS|    & air density               & [kg/m3]        & \verb|map|         \\
           &\verb|U|       & 東西風速                   & [m/s]    & \verb|map| \\
           &\verb|V|       & 南北風速                   & [m/s]    & \verb|map| \\
$\ast\ast$ &\verb|W|       & 鉛直風速                   & [m/s]    & \verb|map| \\
           &\verb|T|       & 気温                      & [K]       & \verb|map| \\
           &\verb|RH|      & 相対湿度 (QVがある場合は省略可) & [\%]    & \verb|map| \\
           &\verb|QV|      & 比湿 (RH がある場合は省略可)   & [kg/kg] & \verb|map| \\
$\ast\ast$ &\verb|QC|      & 雲水の質量比    & [kg/kg] & \verb|map| \\
$\ast\ast$ &\verb|QR|      & 雨水の質量比    & [kg/kg] & \verb|map| \\
$\ast\ast$ &\verb|QI|      & 雲氷の質量比    & [kg/kg] & \verb|map| \\
$\ast\ast$ &\verb|QS|      & 雪の質量比      & [kg/kg] & \verb|map| \\
$\ast\ast$ &\verb|QG|      & 霰の質量比      & [kg/kg] & \verb|map| \\
$\ast\ast$ &\verb|MSLP|    & 海面更正気圧     & [Pa]     & \verb|map| \\
$\ast\ast$ &\verb|PSFC|    & 地上気圧        & [Pa]     & \verb|map| \\
$\ast\ast$ &\verb|U10|     & 10m 東西風速    & [m/s]    & \verb|map| \\
$\ast\ast$ &\verb|V10|     & 10m 南北風速    & [m/s]    & \verb|map| \\
$\ast\ast$ &\verb|T2|      & 2m 気温         & [K]      & \verb|map| \\
$\ast\ast$ &\verb|RH2|     & 2m 相対湿度 (Q2がある場合は省略可) & [\%]  & \verb|map| \\
$\ast\ast$ &\verb|Q2|      & 2m 比湿 (RH2がある場合は省略可)   &[kg/kg] & \verb|map| \\
    $\ast$ &\verb|TOPO|    & GCMの地形                      & [m]      & \verb|map| \\
    $\ast$ &\verb|lsmask|  & GCMの海陸分布                   & 0:海1:陸 & \verb|map| \\
           &\verb|SKINT|   & 地表面温度                      & [K]      & \verb|map| \\
           &\verb|llev|    & 土壌の深さ                      & [m]      & \verb|levels| \\
           &\verb|STEMP|   & 土壌温度                        & [K]      & \verb|map| \\
           &\verb|SMOISVC| & 土壌水分(体積含水率)             & [-] & \verb|map| \\
           &               & (SMOISDS がある場合は省略可)     &                &                    \\
           &\verb|SMOISDS| & 土壌水分(飽和度)                & [-] & \verb|map| \\
           &               & (SMOISVC がある場合は省略可)     &                &                    \\
           &\verb|SST|     & 海面温度(SKINTがある場合は省略可) & [K] & \verb|map|\\ \hline
\end{tabularx}
\end{center}
\end{table}
}
