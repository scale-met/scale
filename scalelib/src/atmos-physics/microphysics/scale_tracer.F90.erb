% # -*- f90 -*-
% # vi: set sw=4 ts=8:
% types = %w(dry kessler tomita08 sn14 suzuki10 sdm)
% vars_int =  %w(QA I_QV I_QC I_QR I_QI I_QS I_QG I_NC I_NR I_NI I_NS I_NG QQA QQS QQE QWS QWE QIS QIE MP_QA AE_QA I_ae_dummy)
% vars_ary =  %w(AQ_NAME AQ_DESC AQ_UNIT I_MP2ALL I_MP2RD I_AE2ALL I_AE2RD)

!-------------------------------------------------------------------------------
!> module TRACER
!!
!! @par Description
!!          Tracer module
!!
!! @author Team SCALE
!!
!! @par History
!! @li      2013-12-04 (S.Nishizawa)   [new]
!!
!<
!-------------------------------------------------------------------------------
! Warning: This file was generated from <%=__FILE__%>.
!          Do not edit this file.
!-------------------------------------------------------------------------------
module scale_tracer
  !-----------------------------------------------------------------------------
  !
  !++ used modules
  !
  use scale_precision
  use scale_stdio
  !-----------------------------------------------------------------------------
  implicit none
  private
  !-----------------------------------------------------------------------------
  !
  !++ Public procedure
  !
  !-----------------------------------------------------------------------------
  !
  !++ Public parameters & variables
  !
#ifdef TRACER
#define EXTM(name) scale_tracer_ ## name ## .f90
#define NAME(name) EXTM(name)
#define XSTR(s) # s
#define STR(s) XSTR(s)
  include STR(NAME(TRACER))
#else
  integer, public :: QA

  integer, public :: I_QV
  integer, public :: I_QC
  integer, public :: I_QR
  integer, public :: I_QI
  integer, public :: I_QS
  integer, public :: I_QG
  integer, public :: I_NC
  integer, public :: I_NR
  integer, public :: I_NI
  integer, public :: I_NS
  integer, public :: I_NG

  integer, public :: QQA ! mass tracer (water)
  integer, public :: QQS ! start index for mass tracer
  integer, public :: QQE ! end   index for mass tracer

  integer, public :: QWS ! start index for water tracer
  integer, public :: QWE ! end   index for water tracer
  integer, public :: QIS ! start index for ice tracer
  integer, public :: QIE ! end   index for ice tracer

  character(len=H_SHORT), public, allocatable :: AQ_NAME(:)
  character(len=H_MID)  , public, allocatable :: AQ_DESC(:)
  character(len=H_SHORT), public, allocatable :: AQ_UNIT(:)

  !-----------------------------------------------------------------------------
  !
  !++ tracer index & relationship (MP_dry+AE_dummy+RD_mstrnx)
  !
  !-----------------------------------------------------------------------------

  integer, public :: MP_QA ! number of hydrometeor tracer
  integer, public, allocatable :: I_MP2ALL(:)

  integer, public, allocatable :: I_MP2RD(:)

  integer, public :: AE_QA ! number of aerosol tracer
  integer, public :: I_ae_dummy
  integer, public, allocatable :: I_AE2ALL(:)

  integer, public, allocatable :: I_AE2RD(:)

  character(len=H_SHORT), public :: TRACER_TYPE = 'NONE'
#endif
  !-----------------------------------------------------------------------------
  !
  !++ Private procedure
  !
  public :: TRACER_setup

  !-----------------------------------------------------------------------------
  !
  !++ Private parameters & variables
  !
  !-----------------------------------------------------------------------------
contains
  !-----------------------------------------------------------------------------
  !> Setup
  subroutine TRACER_setup
#ifndef TRACER
  use scale_process, only: &
    PRC_MPIstop
% types.each do |type|
  use scale_tracer_<%=type%>, only: &
%   (vars_int+vars_ary).each do |var|
    <%=var%>_<%=type%> => <%=var%>, &
%   end
    TRACER_<%=type%>_setup
% end
#endif
    implicit none

#ifndef TRACER
    namelist / PARAM_TRACER / &
         TRACER_TYPE
#endif

    integer :: ierr
    !---------------------------------------------------------------------------

    if( IO_L ) write(IO_FID_LOG,*)
    if( IO_L ) write(IO_FID_LOG,*) '+++ Module[TRACER]/Categ[COMMON]'

#ifndef TRACER
    !--- read namelist
    rewind(IO_FID_CONF)
    read(IO_FID_CONF,nml=PARAM_TRACER,iostat=ierr)

    if( ierr < 0 ) then !--- missing
       if( IO_L ) write(IO_FID_LOG,*) '*** Not found namelist. Default used.'
    elseif( ierr > 0 ) then !--- fatal error
       write(*,*) 'xxx Not appropriate names in namelist PARAM_TRACER. Check!'
       call PRC_MPIstop
    endif
    if( IO_L ) write(IO_FID_LOG,nml=PARAM_TRACER)

    select case (TRACER_TYPE)
% types.each do |type|
    case ("<%=type.upcase%>")
       call TRACER_<%=type%>_setup
%   vars_int.each do |var|
       <%=var%> = <%=var%>_<%=type%>
%   end
       allocate( AQ_NAME(QA) )
       allocate( AQ_DESC(QA) )
       allocate( AQ_UNIT(QA) )
       allocate( I_MP2ALL(MP_QA) )
       allocate( I_MP2RD(MP_QA) )
       allocate( I_AE2ALL(AE_QA) )
       allocate( I_AE2RD(AE_QA) )
%   vars_ary.each do |var|
       <%=var%> = <%=var%>_<%=type%>
%   end
% end
#endif
     case default
        write(*,*) 'xxx Unsupported TRACER_TYPE (', trim(TRACER_TYPE), '). Check!'
        call PRC_MPIstop
     end select

  end subroutine TRACER_setup

end module scale_tracer
